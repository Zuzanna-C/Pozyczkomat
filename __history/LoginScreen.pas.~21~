unit LoginScreen;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, FireDAC.Stan.Intf,
  FireDAC.Comp.Client, FireDAC.DApt, System.Hash, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.Phys.SQLite,
  FireDAC.Phys.SQLiteDef, FireDAC.Stan.ExprFuncs,
  FireDAC.Phys.SQLiteWrapper.Stat, FireDAC.VCLUI.Wait, FireDAC.Stan.Param,
  FireDAC.DatS, FireDAC.DApt.Intf, Data.DB, FireDAC.Comp.DataSet,
  DataModule, MainScreen, ResetPass, Vcl.Imaging.pngimage, AddNewUser;

type
  TForm1 = class(TForm)
    PBackground: TPanel;
    LUser: TLabel;
    LPassword: TLabel;
    EUser: TEdit;
    EPassword: TEdit;
    BLogin: TButton;
    LForgotPass: TLabel;
    LWelcome: TLabel;
    Panel1: TPanel;
    Label1: TLabel;
    Image1: TImage;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    procedure BLoginClick(Sender: TObject);
    procedure BCloseClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure LForgotPassClick(Sender: TObject);
    procedure OnKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Label1Click(Sender: TObject);
  private
    { Private declarations }
    procedure LogIn();
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

function HashPassword(const Password: string): string;
begin
  Result := UpperCase(THashSHA2.GetHashString(Password));
end;

procedure TForm1.LogIn();
var
  Username, Password: string;
  LoggedUserID: Integer;
  MainScreenForm: TForm2;
begin
  Username := Trim(EUser.Text);
  Password := HashPassword(Trim(EPassword.Text));

  DataModule1.FDQueryLogin.Close;
  DataModule1.FDQueryLogin.SQL.Text := 'SELECT * FROM Users WHERE Username = :u AND Password = :p AND Active = 1';
  DataModule1.FDQueryLogin.ParamByName('u').AsString := Username;
  DataModule1.FDQueryLogin.ParamByName('p').AsString := Password;
  DataModule1.FDQueryLogin.Open;


  begin
    if not DataModule1.FDQueryLogin.IsEmpty then
    begin
      LoggedUserID := DataModule1.FDQueryLogin.FieldByName('Id').AsInteger;

      Self.Hide;
      MainScreenForm := TForm2.Create(Self);
      try
        MainScreenForm.LoadUserData(LoggedUserID, username);
        MainScreenForm.ShowModal;
      finally
        MainScreenForm.Free;
        Self.Show;
      end;
    end
    else
      ShowMessage('Nieprawid³owy login lub has³o.');
  end;
end;

procedure TForm1.BCloseClick(Sender: TObject);
begin
  Close;
end;

procedure TForm1.BLoginClick(Sender: TObject);
begin
  LogIn();
end;



procedure TForm1.FormCreate(Sender: TObject);
var
  DbPath, SQLiteDLL: string;
begin
  DbPath := ExtractFilePath(ParamStr(0)) + 'pozyczkomat.db';
  //SQLiteDLL := ExtractFilePath(ParamStr(0)) + 'sqlite3.dll';

//  if not FileExists(SQLiteDLL) then
//  begin
//    MessageDlg('Brak pliku biblioteki SQLite: ' + SQLiteDLL + sLineBreak +
//               'Aplikacja zostanie zamkniêta.', mtError, [mbOK], 0);
//    Application.Terminate;
//    Exit;
//  end;

  if not FileExists(DbPath) then
  begin
    MessageDlg('Nie znaleziono pliku bazy danych: ' + DbPath + sLineBreak +
               'Aplikacja zostanie zamkniêta.', mtError, [mbOK], 0);
    Application.Terminate;
    Exit;
  end;

  with DataModule1.FDConnection do
  begin
    Connected := False;
    Params.Clear;
    Params.DriverID := 'SQLite';
    Params.Database := DbPath;
    LoginPrompt := False;
    Connected := True;
  end;
end;

procedure TForm1.Label1Click(Sender: TObject);
var
  AddNewUserForm: TForm4;
begin
  AddNewUserForm := TForm4.Create(Self);
  try
    AddNewUserForm.ShowModal;
  finally
    AddNewUserForm.Free;
  end;
end;

procedure TForm1.LForgotPassClick(Sender: TObject);
begin
  with TForm3.Create(Self) do
  try
    ShowModal;
  finally
    Free;
  end;
end;

procedure TForm1.OnKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_RETURN then
  begin
    LogIn();
    Key := 0;
  end;
end;

end.
